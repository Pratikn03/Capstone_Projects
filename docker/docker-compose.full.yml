# =============================================================================
# GridPulse Full Production Stack
# Includes: API, Frontend, Prometheus, Grafana, Kafka/Redpanda, PostgreSQL
# =============================================================================

services:
  # ===========================================================================
  # CORE SERVICES
  # ===========================================================================
  
  api:
    build:
      context: ..
      dockerfile: docker/Dockerfile.api
    ports:
      - "8000:8000"
    env_file:
      - path: ../.env
        required: false
    environment:
      - GRIDPULSE_LOG_FORMAT=${GRIDPULSE_LOG_FORMAT:-json}
      - GRIDPULSE_LOG_LEVEL=${GRIDPULSE_LOG_LEVEL:-INFO}
      - GRIDPULSE_METRICS_ENABLED=true
      - POSTGRES_HOST=postgres
      - POSTGRES_PORT=5432
      - POSTGRES_DB=gridpulse
      - POSTGRES_USER=gridpulse
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-gridpulse123}
      - KAFKA_BOOTSTRAP_SERVERS=redpanda:9092
    volumes:
      - ../data:/app/data
      - ../artifacts:/app/artifacts
      - ../reports:/app/reports
    healthcheck:
      test: ["CMD", "python", "-c", "import requests; requests.get('http://localhost:8000/ready', timeout=3).raise_for_status()"]
      interval: 30s
      timeout: 5s
      retries: 3
    depends_on:
      postgres:
        condition: service_healthy
      redpanda:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - gridpulse-net
    labels:
      - "prometheus.scrape=true"
      - "prometheus.port=8000"
      - "prometheus.path=/metrics"

  frontend:
    build:
      context: ..
      dockerfile: docker/Dockerfile.frontend
    ports:
      - "3000:3000"
    depends_on:
      api:
        condition: service_healthy
    environment:
      - FASTAPI_URL=http://api:8000
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - NEXT_PUBLIC_API_URL=http://localhost:8000
    restart: unless-stopped
    networks:
      - gridpulse-net

  # ===========================================================================
  # DATABASE
  # ===========================================================================

  postgres:
    image: postgres:15-alpine
    container_name: gridpulse-postgres
    environment:
      - POSTGRES_DB=gridpulse
      - POSTGRES_USER=gridpulse
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-gridpulse123}
    volumes:
      - postgres-data:/var/lib/postgresql/data
      - ./init-db.sql:/docker-entrypoint-initdb.d/init.sql:ro
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U gridpulse -d gridpulse"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped
    networks:
      - gridpulse-net

  # ===========================================================================
  # STREAMING (Kafka/Redpanda)
  # ===========================================================================

  redpanda:
    image: redpandadata/redpanda:v24.1.1
    container_name: gridpulse-redpanda
    command:
      - redpanda
      - start
      - --overprovisioned
      - --smp
      - "1"
      - --memory
      - "1G"
      - --reserve-memory
      - "0M"
      - --node-id
      - "0"
      - --check=false
      - --kafka-addr
      - PLAINTEXT://0.0.0.0:9092,OUTSIDE://0.0.0.0:19092
      - --advertise-kafka-addr
      - PLAINTEXT://redpanda:9092,OUTSIDE://localhost:19092
      - --pandaproxy-addr
      - PLAINTEXT://0.0.0.0:8082,OUTSIDE://0.0.0.0:18082
      - --advertise-pandaproxy-addr
      - PLAINTEXT://redpanda:8082,OUTSIDE://localhost:18082
    ports:
      - "9092:9092"
      - "19092:19092"
      - "8082:8082"
      - "18082:18082"
      - "9644:9644"  # Admin API & Prometheus metrics
    volumes:
      - redpanda-data:/var/lib/redpanda/data
    healthcheck:
      test: ["CMD", "rpk", "cluster", "health"]
      interval: 15s
      timeout: 10s
      retries: 5
    restart: unless-stopped
    networks:
      - gridpulse-net

  redpanda-console:
    image: redpandadata/console:v2.4.3
    container_name: gridpulse-console
    entrypoint: /bin/sh
    command: -c "echo \"$$CONSOLE_CONFIG_FILE\" > /tmp/config.yml; /app/console"
    environment:
      CONFIG_FILEPATH: /tmp/config.yml
      CONSOLE_CONFIG_FILE: |
        kafka:
          brokers: ["redpanda:9092"]
        redpanda:
          adminApi:
            enabled: true
            urls: ["http://redpanda:9644"]
    ports:
      - "8080:8080"
    depends_on:
      redpanda:
        condition: service_healthy
    networks:
      - gridpulse-net

  # ===========================================================================
  # OBSERVABILITY STACK
  # ===========================================================================

  prometheus:
    image: prom/prometheus:v2.50.1
    container_name: gridpulse-prometheus
    command:
      - "--config.file=/etc/prometheus/prometheus.yml"
      - "--storage.tsdb.path=/prometheus"
      - "--storage.tsdb.retention.time=15d"
      - "--web.enable-lifecycle"
      - "--web.enable-admin-api"
    volumes:
      - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - ./prometheus/rules:/etc/prometheus/rules:ro
      - prometheus-data:/prometheus
    ports:
      - "9090:9090"
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:9090/-/healthy"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped
    networks:
      - gridpulse-net

  grafana:
    image: grafana/grafana:10.3.3
    container_name: gridpulse-grafana
    environment:
      - GF_SECURITY_ADMIN_USER=${GRAFANA_ADMIN_USER:-admin}
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_ADMIN_PASSWORD:-gridpulse123}
      - GF_USERS_ALLOW_SIGN_UP=false
      - GF_SERVER_HTTP_PORT=3001
      - GF_INSTALL_PLUGINS=grafana-clock-panel,grafana-simple-json-datasource
    volumes:
      - ./grafana/provisioning:/etc/grafana/provisioning:ro
      - grafana-data:/var/lib/grafana
    ports:
      - "3001:3001"
    depends_on:
      prometheus:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:3001/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped
    networks:
      - gridpulse-net

  alertmanager:
    image: prom/alertmanager:v0.27.0
    container_name: gridpulse-alertmanager
    command:
      - "--config.file=/etc/alertmanager/alertmanager.yml"
      - "--storage.path=/alertmanager"
    volumes:
      - ./alertmanager/alertmanager.yml:/etc/alertmanager/alertmanager.yml:ro
      - alertmanager-data:/alertmanager
    ports:
      - "9093:9093"
    restart: unless-stopped
    networks:
      - gridpulse-net

  # Node Exporter for system metrics
  node-exporter:
    image: prom/node-exporter:v1.7.0
    container_name: gridpulse-node-exporter
    command:
      - "--path.rootfs=/host"
    volumes:
      - "/:/host:ro,rslave"
    ports:
      - "9100:9100"
    restart: unless-stopped
    networks:
      - gridpulse-net

  # cAdvisor for container metrics
  cadvisor:
    image: gcr.io/cadvisor/cadvisor:v0.49.1
    container_name: gridpulse-cadvisor
    privileged: true
    volumes:
      - /:/rootfs:ro
      - /var/run:/var/run:ro
      - /sys:/sys:ro
      - /var/lib/docker/:/var/lib/docker:ro
      - /dev/disk/:/dev/disk:ro
    ports:
      - "8081:8080"
    restart: unless-stopped
    networks:
      - gridpulse-net

  # ===========================================================================
  # STREAMING WORKER
  # ===========================================================================

  streaming-worker:
    build:
      context: ..
      dockerfile: docker/Dockerfile.api
    container_name: gridpulse-streaming-worker
    command: ["python", "-m", "gridpulse.streaming.worker"]
    env_file:
      - ../.env
    environment:
      - KAFKA_BOOTSTRAP_SERVERS=redpanda:9092
      - KAFKA_TOPIC=gridpulse-telemetry
      - KAFKA_GROUP_ID=gridpulse-streaming-worker
      - DUCKDB_PATH=/app/data/streaming/events.duckdb
    volumes:
      - ../data:/app/data
      - ../artifacts:/app/artifacts
    depends_on:
      redpanda:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - gridpulse-net

# =============================================================================
# VOLUMES
# =============================================================================

volumes:
  postgres-data:
  redpanda-data:
  prometheus-data:
  grafana-data:
  alertmanager-data:

# =============================================================================
# NETWORKS
# =============================================================================

networks:
  gridpulse-net:
    driver: bridge
